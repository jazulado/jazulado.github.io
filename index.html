<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
</head>

<body>
  <script type="text/javascript">
    let width = 600
    let height = 600
    let type = "WebGL"
    if (!PIXI.utils.isWebGLSupported()) {
      type = "canvas"
    }
    let app = new PIXI.Application({
      width: width,
      height: height,
      antialias: true,
      transparent: false,
      resolution: 1
    });

    //Add the canvas that Pixi automatically created for you to the HTML document
    document.body.appendChild(app.view);

    //load an image and run the `setup` function when it's done
    PIXI.loader
      .add("texture/abajo2.png")
      .load(setup);
    let dungeon = PIXI.Sprite.from("texture/grass.png");
    let arriba = PIXI.Texture.from('texture/arriba.png');
    let abajo = PIXI.Texture.from('texture/abajo.png');
    let izquierda = PIXI.Texture.from('texture/izquierda.png');
    let derecha = PIXI.Texture.from('texture/derecha.png');
    let arbol = PIXI.Texture.from('texture/arbol.png');
    let abajoImages = ["texture/abajo.png", "texture/abajo1.png", "texture/abajo.png", "texture/abajo2.png"];
    let arribaImages = ["texture/arriba.png", "texture/arriba1.png", "texture/arriba.png", "texture/arriba2.png"];
    let izquierdaImages = ["texture/izquierda.png", "texture/izquierda1.png", "texture/izquierda.png",
      "texture/izquierda2.png"
    ];
    let derechaImages = ["texture/derecha.png", "texture/derecha1.png", "texture/derecha.png", "texture/derecha2.png"];
    let golpearImages = ["texture/golpear1.png", "texture/golpear2.png", "texture/golpear3.png",
      "texture/golpear3.png"
    ];

    let abajotexarray = [];
    let arribatexarray = [];
    let izquierdatexarray = [];
    let derechatexarray = [];
    let golpeartexarray = [];

    for (let i = 0; i <= 3; i++) {
      let abajotexture = PIXI.Texture.from(abajoImages[i]);
      abajotexarray.push(abajotexture);
      let arribatexture = PIXI.Texture.from(arribaImages[i]);
      arribatexarray.push(arribatexture);
      let izquierdatexture = PIXI.Texture.from(izquierdaImages[i]);
      izquierdatexarray.push(izquierdatexture);
      let derechatexture = PIXI.Texture.from(derechaImages[i]);
      derechatexarray.push(derechatexture);
      let golpeartexture = PIXI.Texture.from(golpearImages[i]);
      golpeartexarray.push(golpeartexture);
    };



    let sprite = new PIXI.Sprite(abajo);
    var collisiona = false
    var inix = 0;
    var iniy = 0;
    var cenx = width / 2;
    var ceny = height / 2;
    var keys = {
      a: false,
      w: false,
      s: false,
      d: false,
      esp: false
    };
    var animId = 0;
    let fondo = new PIXI.Container();
    let arboles = new PIXI.Container();
    for (let i = 0; i < 20; i++) {
      var arb = PIXI.Sprite.from('texture/arbol.png');

      var randx =  Math.floor((Math.random()) * 600)
      var randy = Math.floor((Math.random()) * 600)
      if (i % 2 == 0) {
        randx = -randx
        //randy = -randy
      }
      arb.position.set(randx, randy)
      arboles.addChild(arb);
    }
    //This `setup` function will run when the image has loaded
    function generateBackground(x, y) {
      fondo.removeChildren()
      for (let w = -10; w < 10; w++) {
        for (let h = -10; h < 10; h++) {
          var dun = PIXI.Sprite.from("texture/grass.png");
          dun.width = 100;
          dun.height = 100;
          dun.position.set(cenx + w * 100 + x, ceny + h * 100 + y)
          //app.stage.addChild(dun);
          fondo.addChild(dun);


        }

      }
      arboles.x = x
      arboles.y = y
      app.stage.addChild(fondo)
      app.stage.addChild(arboles)
      app.stage.addChild(sprite);


    }

    function matrix(m, n) {
      var result = []
      for (var i = 0; i < n; i++) {
        result.push(new Array(m).fill(0))
      }
      return result
    }
    map = matrix(20, 20)
    generateBackground(0, 0)

    function setup() {
      sprite.position.set(width / 2, height / 2)
      sprite.width = sprite.width * 2;
      sprite.height = sprite.height * 2;
      app.stage.addChild(sprite);
    }

    function golpe() {

      setTimeout(function () {
        sprite.texture = golpeartexarray[animId];
        animId++;
        if (animId != 4) {
          golpe()
        } else {
          sprite.texture = golpeartexarray[0];
        }
      }, 150);
    }

    function verColision(x, y) {
      for (let k = 0; k < arboles.children.length; k++) {
        if (y < arboles.position.y + arboles.children[k].y + 20 &&
          y > arboles.position.y + arboles.children[k].y - 20)// &&
         // x < arboles.position.x + arboles.children[k].x + 20 &&
          //x > arboles.position.x + arboles.children[k].x - 20) {
            {
          //console.log("EE")
          //return true
        } else {
          //console.log("A")
          //return false
        }
      }

    }

    function camina() {
      if (keys["a"]) {
        if (!verColision(sprite.x - 5, sprite.y)) {
          if (sprite.x > cenx - width / 3) {
            sprite.x = sprite.x - 5;
          } else {

            inix = inix + 5;
            generateBackground(inix, iniy);
          }
        }
        if (animId == 4) {
          animId = 0;
        }
        sprite.texture = izquierdatexarray[animId];
        animId++;
      }
      if (keys["d"]) {
          if (!verColision(sprite.x + 5, sprite.y)) {
        if (sprite.x < cenx + width / 3) {
            sprite.x = sprite.x + 5;
        } else {
          inix = inix - 5;
          generateBackground(inix, iniy);
        }
          }
        if (animId == 4) {
          animId = 0;
        }
        sprite.texture = derechatexarray[animId];
        animId++;
      }
      //
      if (keys["w"]) {
          if (!verColision(sprite.x, sprite.y - 5)) {
        if (sprite.y > ceny - height / 3) {
            sprite.y = sprite.y - 5;

        } else {
          iniy = iniy + 5;
          generateBackground(inix, iniy);
        }
          }
        if (animId == 4) {
          animId = 0;
        }
        sprite.texture = arribatexarray[animId];
        animId++;
      }
      if (keys["s"]) {
          if (!verColision(sprite.x, sprite.y + 5)) {
        if (sprite.y < ceny + (height / 3)) {
            sprite.y = sprite.y + 5;
        } else {
          iniy = iniy - 5;
          generateBackground(inix, iniy);
        }
          }
        if (animId == 4) {
          animId = 0;
        }
        sprite.texture = abajotexarray[animId];
        animId++;
        //sprite.texture = abajo;
      }
      if (keys["esp"]) {
        animId = 0;
        golpe();
      }
    }
    document.addEventListener('keydown', function (event) {
      switch (event.keyCode) {
        case 65:
          keys["a"] = true
          //inix = inix - 5;
          break;
        case 68:
          keys["d"] = true
          //inix = inix + 5;
          break;
        case 87:
          keys["w"] = true
          //iniy = iniy - 5;
          break;
        case 83:
          keys["s"] = true
          //iniy = iniy + 5;
          break;
        case 32:
          keys["esp"] = true
          //iniy = iniy + 5;
          break;
      }

      camina()



    });

    document.addEventListener('keyup', function (event) {
      switch (event.keyCode) {
        case 65:
          keys["a"] = false
          break;
        case 68:
          keys["d"] = false
          break;
        case 87:
          keys["w"] = false
          break;
        case 83:
          keys["s"] = false
          break;
        case 32:
          keys["esp"] = false
          break;
      }

    });

    // app.stage.removeChild(sprite)
  </script>

</body>

</html>